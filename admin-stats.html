<!DOCTYPE html>
<html lang="nl">
<head>
    <title>SourceMedia - Live Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Poppins', sans-serif; }</style>
</head>
<body class="bg-slate-900 text-white p-6 md:p-10">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
            SourceMedia Statistieken
        </h1>
        
        <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                <p class="text-gray-400 text-xs uppercase tracking-wide font-semibold">Totaal Bekeken</p>
                <p id="total-visits" class="text-5xl font-extrabold mt-4 text-white">...</p>
            </div>

            <div class="bg-slate-800 p-6 rounded-2xl border border-purple-500/30 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 w-24 h-24 bg-purple-500/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                <p class="text-purple-300 text-xs uppercase tracking-wide font-semibold">Unieke Personen</p>
                <p id="unique-visitors" class="text-5xl font-extrabold mt-4 text-white">...</p>
            </div>
            
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                <p class="text-gray-400 text-xs uppercase tracking-wide font-semibold">Laatste Bezoeker</p>
                <p id="last-visit" class="text-xl font-bold mt-4 text-blue-300">Laden...</p>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl">
            <div class="p-6 border-b border-slate-700 bg-slate-800/50">
                <h3 class="font-bold text-lg">Recent Verkeer</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left whitespace-nowrap">
                    <thead class="bg-slate-900/50 text-gray-400 text-xs uppercase">
                        <tr>
                            <th class="p-4 font-semibold">Tijdstip</th>
                            <th class="p-4 font-semibold">Visitor ID</th>
                            <th class="p-4 font-semibold">Apparaat</th>
                        </tr>
                    </thead>
                    <tbody id="visits-table" class="divide-y divide-slate-700 text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://tkuotdaoapdvwowbkdsd.supabase.co";
        const SUPABASE_KEY = "sb_publishable_uLjCLL9ekIvwxybpbDkzSg_IfeAsotc";

        async function fetchStats() {
            try {
                // Haal data op en sorteer op nieuwste eerst
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Bezoeken?select=*&order=created_at.desc`, {
                    headers: { 
                        "apikey": SUPABASE_KEY, 
                        "Authorization": `Bearer ${SUPABASE_KEY}` 
                    }
                });
                
                if (!res.ok) throw new Error('Fout bij ophalen data');
                
                const data = await res.json();
                
                // 1. Totaal aantal
                document.getElementById('total-visits').innerText = data.length;

                // 2. Unieke bezoekers berekenen
                // We filteren dubbele IDs eruit
                const uniqueSet = new Set(data.map(item => item.visitor_id).filter(id => id));
                document.getElementById('unique-visitors').innerText = uniqueSet.size;

                // 3. Laatste bezoeker tijdstip
                if (data.length > 0) {
                    const lastDate = new Date(data[0].created_at);
                    document.getElementById('last-visit').innerText = lastDate.toLocaleString('nl-NL', { 
                        weekday: 'short', hour: '2-digit', minute: '2-digit' 
                    });
                } else {
                    document.getElementById('last-visit').innerText = "Nog geen bezoekers";
                }

                // 4. Tabel vullen
                const tableBody = document.getElementById('visits-table');
                tableBody.innerHTML = data.slice(0, 20).map(visit => {
                    const date = new Date(visit.created_at).toLocaleString('nl-NL');
                    
                    // Apparaat check
                    const isMobile = visit.user_agent && visit.user_agent.toLowerCase().includes('mobile') ? 'ðŸ“± Mobiel' : 'ðŸ’» Desktop';
                    
                    // ID inkorten voor nette weergave (laatste 6 tekens)
                    // Als er geen ID is, toon streepje
                    const shortID = visit.visitor_id ? `<span class="font-mono text-gray-500">...${visit.visitor_id.slice(-6)}</span>` : '-';
                    
                    return `
                        <tr class="hover:bg-slate-700/50 transition-colors">
                            <td class="p-4 text-gray-300">${date}</td>
                            <td class="p-4">${shortID}</td>
                            <td class="p-4 text-gray-400 text-xs">${isMobile}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                document.getElementById('total-visits').innerText = "Err";
            }
        }
        
        // Ververs de stats elke 10 seconden
        fetchStats();
        setInterval(fetchStats, 10000);
    </script>
</body>
</html>
